<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Aprender chino</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        :root {
            font-size: 16px;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            margin: 0;
            padding: 0.75rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
        }
        h1 {
            text-align: center;
            font-size: 1.4rem;
            margin: 0.5rem 0 1rem;
        }
        .fila {
            margin-bottom: 0.75rem;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        input[type="text"],
        textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 0.4rem 0.5rem;
            font-size: 1rem;
        }
        button {
            padding: 0.5rem 0.75rem;
            margin: 0.15rem;
            font-size: 0.95rem;
            border-radius: 4px;
            border: 1px solid #888;
            background: #f4f4f4;
        }
        button:active {
            background: #ddd;
        }
        .botonera-principal {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        .botonera-principal button {
            flex: 1 1 45%;
        }
        .solucion {
            background-color: #eef;
            padding: 0.35rem;
            margin-top: 0.25rem;
            min-height: 1.1rem;
            font-size: 0.9rem;
        }
        .modo {
            margin-bottom: 0.5rem;
            font-style: italic;
            font-size: 0.9rem;
        }
        hr {
            margin: 0.9rem 0;
        }
        .estado-frase {
            font-size: 0.85rem;
            color: #333;
        }
        #panelFrases {
            margin-top: 0.75rem;
            padding: 0.5rem;
            border: 1px solid #bbb;
            background-color: #f9f9f9;
        }
        #panelFrases h2 {
            margin-top: 0;
            font-size: 1.1rem;
        }
        #panelFrases p {
            font-size: 0.85rem;
        }
        .tabla-wrapper {
            width: 100%;
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 600px;
            font-size: 0.85rem;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 0.25rem;
            text-align: left;
        }
        th {
            background-color: #ddd;
        }
        .inputTabla {
            width: 100%;
            box-sizing: border-box;
            font-size: 0.85rem;
        }
        .form-nueva-frase input {
            width: 100%;
            box-sizing: border-box;
            font-size: 0.9rem;
            padding: 0.3rem 0.4rem;
        }
        .fila-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.35rem;
            flex-wrap: wrap;
        }
        .fila-top span {
            font-size: 0.95rem;
        }
        @media (min-width: 600px) {
            .botonera-principal button {
                flex: 0 0 auto;
            }
        }
    </style>
</head>
<body>
    <h1>Aprender chino</h1>

    <div class="modo" id="modoTexto"></div>

    <div class="fila fila-top">
        <div>
            <strong>Frase nº: </strong><span id="indiceFrase"></span>
        </div>
        <div>
            <button onclick="anteriorFrase()">Anterior</button>
            <button onclick="siguienteFrase()">Siguiente</button>
        </div>
    </div>

    <div class="fila">
        <label>Hanzi (modelo):</label>
        <span id="hanziModelo"></span>
    </div>

    <div class="fila">
        <label>Pinyin (modelo):</label>
        <span id="pinyinModelo"></span>
    </div>

    <div class="fila">
        <label>Español (modelo):</label>
        <span id="espanolModelo"></span>
    </div>

    <div class="fila">
        <label>Estado de la frase:</label>
        <div id="estadoFrase" class="estado-frase"></div>
    </div>

    <hr>

    <div class="fila">
        <label>Hanzi (tu respuesta):</label>
        <input type="text" id="hanziUsuario">
        <div class="solucion" id="resultadoHanzi"></div>
    </div>

    <div class="fila">
        <label>Pinyin (tu respuesta):</label>
        <input type="text" id="pinyinUsuario" placeholder="Escribe pinyin con números (ej: ni3 hao3)">
        <div class="solucion" id="resultadoPinyin"></div>
    </div>

    <div class="fila">
        <label>Español (tu respuesta):</label>
        <textarea id="espanolUsuario" rows="2"></textarea>
        <div class="solucion" id="resultadoEspanol"></div>
    </div>

    <hr>

    <div class="fila botonera-principal">
        <button onclick="modoTodas()">TODAS</button>
        <button onclick="modoClean()">CLEAN</button>
        <button onclick="modoChino()">CHINO</button>
        <button onclick="modoEspanol()">ESPAÑOL</button>
        <button onclick="comprobar()">Comprobar</button>
        <button onclick="togglePanelFrases()">Frases</button>
        <button onclick="exportarHistorial()">Exportar historial</button>
    </div>

    <div id="panelFrases" style="display:none;">
        <h2>Frases del ejercicio</h2>
        <p>
            Aquí puedes ver, editar y añadir frases.  
            Se registran prácticas, completaciones y si están aprendidas semanal y mensualmente.
        </p>
        <div class="tabla-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Hanzi</th>
                        <th>Pinyin</th>
                        <th>Español</th>
                        <th>Última práctica</th>
                        <th>Último completado</th>
                        <th>Aprendido semanal</th>
                        <th>Aprendido mensual</th>
                    </tr>
                </thead>
                <tbody id="tablaFrasesBody"></tbody>
            </table>
        </div>

        <div class="form-nueva-frase">
            <h3>Añadir nueva frase</h3>
            <table>
                <tr>
                    <td>Hanzi</td>
                    <td><input type="text" id="nuevoHanzi"></td>
                </tr>
                <tr>
                    <td>Pinyin</td>
                    <td><input type="text" id="nuevoPinyin" placeholder="Con tonos (Zhōngguó...)"></td>
                </tr>
                <tr>
                    <td>Español</td>
                    <td><input type="text" id="nuevoEspanol"></td>
                </tr>
            </table>
            <button onclick="anadirFrase()">Añadir frase</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY = "aprendeChino_frases_pwa_v1";

        let frases = [let frases = [
    /* =======================
       50 FRASES COTIDIANAS
       ======================= */
    { hanzi:"你好。", pinyin:"Nǐ hǎo.", espanol:"Hola." },
    { hanzi:"谢谢。", pinyin:"Xièxie.", espanol:"Gracias." },
    { hanzi:"对不起。", pinyin:"Duìbuqǐ.", espanol:"Perdón." },
    { hanzi:"请问，厕所在哪里？", pinyin:"Qǐngwèn, cèsuǒ zài nǎlǐ?", espanol:"Disculpe, ¿dónde está el baño?" },
    { hanzi:"我听不懂。", pinyin:"Wǒ tīng bù dǒng.", espanol:"No entiendo." },
    { hanzi:"你可以说慢一点吗？", pinyin:"Nǐ kěyǐ shuō màn yìdiǎn ma?", espanol:"¿Puedes hablar más despacio?" },
    { hanzi:"这是什么意思？", pinyin:"Zhè shì shénme yìsi?", espanol:"¿Qué significa esto?" },
    { hanzi:"我会一点中文。", pinyin:"Wǒ huì yìdiǎn Zhōngwén.", espanol:"Sé un poco de chino." },
    { hanzi:"请再说一遍。", pinyin:"Qǐng zài shuō yí biàn.", espanol:"Por favor, repítelo." },
    { hanzi:"可以帮我吗？", pinyin:"Kěyǐ bāng wǒ ma?", espanol:"¿Puedes ayudarme?" },

    { hanzi:"我想去地铁站。", pinyin:"Wǒ xiǎng qù dìtiě zhàn.", espanol:"Quiero ir a la estación de metro." },
    { hanzi:"出租车在哪里？", pinyin:"Chūzūchē zài nǎlǐ?", espanol:"¿Dónde están los taxis?" },
    { hanzi:"请带我去机场。", pinyin:"Qǐng dài wǒ qù jīchǎng.", espanol:"Lléveme al aeropuerto." },
    { hanzi:"这里怎么走？", pinyin:"Zhèlǐ zěnme zǒu?", espanol:"¿Cómo se va desde aquí?" },
    { hanzi:"我要去这个地址。", pinyin:"Wǒ yào qù zhège dìzhǐ.", espanol:"Quiero ir a esta dirección." },
    { hanzi:"到那里要多长时间？", pinyin:"Dào nàlǐ yào duō cháng shíjiān?", espanol:"¿Cuánto tiempo se tarda?" },
    { hanzi:"请给我看地图。", pinyin:"Qǐng gěi wǒ kàn dìtú.", espanol:"Enséñeme el mapa." },
    { hanzi:"我们刚到中国。", pinyin:"Wǒmen gāng dào Zhōngguó.", espanol:"Acabamos de llegar a China." },
    { hanzi:"请帮我叫一辆车。", pinyin:"Qǐng bāng wǒ jiào yí liàng chē.", espanol:"Ayúdeme a pedir un coche." },
    { hanzi:"这是去市中心的吗？", pinyin:"Zhè shì qù shìzhōngxīn de ma?", espanol:"¿Esto va al centro?" },

    { hanzi:"我想要一瓶水。", pinyin:"Wǒ xiǎng yào yì píng shuǐ.", espanol:"Quiero una botella de agua." },
    { hanzi:"这个多少钱？", pinyin:"Zhège duōshǎo qián?", espanol:"¿Cuánto cuesta esto?" },
    { hanzi:"可以刷卡吗？", pinyin:"Kěyǐ shuākǎ ma?", espanol:"¿Puedo pagar con tarjeta?" },
    { hanzi:"请推荐一下。", pinyin:"Qǐng tuījiàn yíxià.", espanol:"Recomiéndeme algo." },
    { hanzi:"我对这个过敏。", pinyin:"Wǒ duì zhège guòmǐn.", espanol:"Soy alérgico a esto." },
    { hanzi:"我可以试试吗？", pinyin:"Wǒ kěyǐ shìshi ma?", espanol:"¿Puedo probarlo?" },
    { hanzi:"我要一个不辣的。", pinyin:"Wǒ yào yí gè bú là de.", espanol:"Lo quiero sin picante." },
    { hanzi:"味道很好。", pinyin:"Wèidào hěn hǎo.", espanol:"Está muy rico." },
    { hanzi:"请给我发票。", pinyin:"Qǐng gěi wǒ fāpiào.", espanol:"Deme un recibo." },
    { hanzi:"可以坐这里吗？", pinyin:"Kěyǐ zuò zhèlǐ ma?", espanol:"¿Puedo sentarme aquí?" },

    { hanzi:"我需要一间安静的房间。", pinyin:"Wǒ xūyào yì jiān ānjìng de fángjiān.", espanol:"Necesito una habitación tranquila." },
    { hanzi:"我已经预订了。", pinyin:"Wǒ yǐjīng yùdìng le.", espanol:"Ya he reservado." },
    { hanzi:"空调不能用。", pinyin:"Kōngtiáo bù néng yòng.", espanol:"El aire acondicionado no funciona." },
    { hanzi:"请帮我叫服务员。", pinyin:"Qǐng bāng wǒ jiào fúwùyuán.", espanol:"Llame al camarero, por favor." },
    { hanzi:"我找不到我的房卡。", pinyin:"Wǒ zhǎo bù dào wǒ de fángkǎ.", espanol:"No encuentro mi tarjeta." },
    { hanzi:"可以帮我换一下房间吗？", pinyin:"Kěyǐ bāng wǒ huàn yíxià fángjiān ma?", espanol:"¿Puedo cambiar de habitación?" },
    { hanzi:"请明天早上叫醒我。", pinyin:"Qǐng míngtiān zǎoshang jiàoxǐng wǒ.", espanol:"Despiérteme mañana temprano." },
    { hanzi:"我需要一辆出租车。", pinyin:"Wǒ xūyào yí liàng chūzūchē.", espanol:"Necesito un taxi." },
    { hanzi:"网络有问题。", pinyin:"Wǎngluò yǒu wèntí.", espanol:"La red tiene un problema." },
    { hanzi:"可以帮我打印文件吗？", pinyin:"Kěyǐ bāng wǒ dǎyìn wénjiàn ma?", espanol:"¿Puedes imprimirme un documento?" },

    { hanzi:"我觉得这里很方便。", pinyin:"Wǒ juéde zhèlǐ hěn fāngbiàn.", espanol:"Creo que este lugar es práctico." },
    { hanzi:"你喜欢中国菜吗？", pinyin:"Nǐ xǐhuān Zhōngguó cài ma?", espanol:"¿Te gusta la comida china?" },
    { hanzi:"我还没吃早饭。", pinyin:"Wǒ hái méi chī zǎofàn.", espanol:"Aún no he desayunado." },
    { hanzi:"我们可以一起去吗？", pinyin:"Wǒmen kěyǐ yìqǐ qù ma?", espanol:"¿Podemos ir juntos?" },
    { hanzi:"今天比昨天更冷。", pinyin:"Jīntiān bǐ zuótiān gèng lěng.", espanol:"Hoy hace más frío que ayer." },
    { hanzi:"我想多练习中文。", pinyin:"Wǒ xiǎng duō liànxí Zhōngwén.", espanol:"Quiero practicar más chino." },
    { hanzi:"你可以推荐一个地方吗？", pinyin:"Nǐ kěyǐ tuījiàn yí gè dìfāng ma?", espanol:"¿Puedes recomendarme un sitio?" },
    { hanzi:"我很喜欢这个城市。", pinyin:"Wǒ hěn xǐhuān zhège chéngshì.", espanol:"Me gusta mucho esta ciudad." },
    { hanzi:"我们几点出发？", pinyin:"Wǒmen jǐ diǎn chūfā?", espanol:"¿A qué hora salimos?" },
    { hanzi:"希望今天顺利。", pinyin:"Xīwàng jīntiān shùnlì.", espanol:"Espero que hoy vaya bien." },

    /* =======================
       50 FRASES PROFESIONALES
       ======================= */
    { hanzi:"我是安东尼奥。", pinyin:"Wǒ shì Āndōngní'ào.", espanol:"Soy Antonio." },
    { hanzi:"很高兴认识您。", pinyin:"Hěn gāoxìng rènshí nín.", espanol:"Encantado de conocerle." },
    { hanzi:"谢谢史教授的邀请。", pinyin:"Xièxie Shǐ jiàoshòu de yāoqǐng.", espanol:"Gracias por la invitación, Profesor Shi." },
    { hanzi:"我来自塞维利亚大学。", pinyin:"Wǒ láizì Sàiwéilìyà Dàxué.", espanol:"Vengo de la Universidad de Sevilla." },
    { hanzi:"我们研究建筑可持续性。", pinyin:"Wǒmen yánjiū jiànzhù kěchíxùxìng.", espanol:"Investigamos la sostenibilidad en edificios." },
    { hanzi:"今天我想介绍我们的工作。", pinyin:"Jīntiān wǒ xiǎng jièshào wǒmen de gōngzuò.", espanol:"Hoy quiero presentar nuestro trabajo." },
    { hanzi:"希望我们能加强合作。", pinyin:"Xīwàng wǒmen néng jiāqiáng hézuò.", espanol:"Espero que podamos fortalecer la colaboración." },
    { hanzi:"请问现在方便讨论吗？", pinyin:"Qǐngwèn xiànzài fāngbiàn tǎolùn ma?", espanol:"¿Es buen momento para hablar?" },
    { hanzi:"这个项目对我们很重要。", pinyin:"Zhège xiàngmù duì wǒmen hěn zhòngyào.", espanol:"Este proyecto es muy importante para nosotros." },
    { hanzi:"我们可以从数据开始吗？", pinyin:"Wǒmen kěyǐ cóng shùjù kāishǐ ma?", espanol:"¿Podemos empezar hablando de los datos?" },

    { hanzi:"我们在研究建筑信息模型。", pinyin:"Wǒmen zài yánjiū jiànzhù xìnxī móxíng.", espanol:"Estamos investigando BIM." },
    { hanzi:"我们需要可靠的数据。", pinyin:"Wǒmen xūyào kěkào de shùjù.", espanol:"Necesitamos datos fiables." },
    { hanzi:"中国的数据非常有价值。", pinyin:"Zhōngguó de shùjù fēicháng yǒu jiàzhí.", espanol:"Los datos de China son muy valiosos." },
    { hanzi:"我们想了解您的数据流程。", pinyin:"Wǒmen xiǎng liǎojiě nín de shùjù liúchéng.", espanol:"Queremos conocer su flujo de datos." },
    { hanzi:"这个系统支持数据共享吗？", pinyin:"Zhège xìtǒng zhīchí shùjù gòngxiǎng ma?", espanol:"¿Este sistema permite compartir datos?" },
    { hanzi:"我们正在开发一个数字化工具。", pinyin:"Wǒmen zhèngzài kāifā yí gè shùzìhuà gōngjù.", espanol:"Estamos desarrollando una herramienta digital." },
    { hanzi:"这是我们最近的数据平台。", pinyin:"Zhè shì wǒmen zuìjìn de shùjù píngtái.", espanol:"Esta es nuestra plataforma de datos más reciente." },
    { hanzi:"您使用什么BIM标准？", pinyin:"Nín shǐyòng shénme BIM biāozhǔn?", espanol:"¿Qué estándares BIM utiliza?" },
    { hanzi:"这个模型可以自动计算吗？", pinyin:"Zhège móxíng kěyǐ zìdòng jìsuàn ma?", espanol:"¿El modelo puede calcular automáticamente?" },
    { hanzi:"我想看看您的示例项目。", pinyin:"Wǒ xiǎng kànkan nín de shìlì xiàngmù.", espanol:"Me gustaría ver sus proyectos de ejemplo." },

    { hanzi:"我们正在做生命周期分析。", pinyin:"Wǒmen zhèngzài zuò shēngmìng zhōuqī fēnxī.", espanol:"Estamos haciendo análisis de ciclo de vida." },
    { hanzi:"我们的方法基于欧洲标准。", pinyin:"Wǒmen de fāngfǎ jīyú Ōuzhōu biāozhǔn.", espanol:"Nuestro método se basa en estándares europeos." },
    { hanzi:"中国有哪些相关标准？", pinyin:"Zhōngguó yǒu nǎxiē xiāngguān biāozhǔn?", espanol:"¿Qué estándares existen en China?" },
    { hanzi:"我们比较了不同的碳排放模型。", pinyin:"Wǒmen bǐjiào le bùtóng de tàn páifàng móxíng.", espanol:"Hemos comparado distintos modelos de emisiones." },
    { hanzi:"您怎么看待基线数据？", pinyin:"Nín zěnme kàndài jīxiàn shùjù?", espanol:"¿Cómo ve los datos de línea base?" },
    { hanzi:"我们正在创建全国数据库。", pinyin:"Wǒmen zhèngzài chuàngjiàn quánguó shùjùkù.", espanol:"Estamos creando una base de datos nacional." },
    { hanzi:"哪些数据最难收集？", pinyin:"Nǎxiē shùjù zuì nán shōují?", espanol:"¿Qué datos son los más difíciles de recolectar?" },
    { hanzi:"我们也在做建筑碳足迹研究。", pinyin:"Wǒmen yě zài zuò jiànzhù tànzújì yánjiū.", espanol:"También estudiamos huella de carbono de edificios." },
    { hanzi:"这个材料的影响大吗？", pinyin:"Zhège cáiliào de yǐngxiǎng dà ma?", espanol:"¿El impacto de este material es grande?" },
    { hanzi:"能给我们一些建议吗？", pinyin:"Néng gěi wǒmen yìxiē jiànyì ma?", espanol:"¿Puede darnos algunas recomendaciones?" },

    { hanzi:"我们在开发建筑数字护照。", pinyin:"Wǒmen zài kāifā jiànzhù shùzì hùzhào.", espanol:"Estamos desarrollando un pasaporte digital." },
    { hanzi:"核心是数据可追溯性。", pinyin:"Héxīn shì shùjù kě zhuīsùxìng.", espanol:"Lo esencial es la trazabilidad de datos." },
    { hanzi:"材料信息必须可验证。", pinyin:"Cáiliào xìnxī bìxū kě yànzhèng.", espanol:"La información de materiales debe ser verificable." },
    { hanzi:"我们需要实时数据。", pinyin:"Wǒmen xūyào shíshí shùjù.", espanol:"Necesitamos datos en tiempo real." },
    { hanzi:"您有类似的数字项目吗？", pinyin:"Nín yǒu lèisì de shùzì xiàngmù ma?", espanol:"¿Tiene proyectos digitales similares?" },
    { hanzi:"流程能自动同步吗？", pinyin:"Liúchéng néng zìdòng tóngbù ma?", espanol:"¿El proceso puede sincronizarse automáticamente?" },
    { hanzi:"我们比较不同的数据格式。", pinyin:"Wǒmen bǐjiào bùtóng de shùjù géshì.", espanol:"Comparamos distintos formatos de datos." },
    { hanzi:"可以提供样本数据吗？", pinyin:"Kěyǐ tígōng yàngběn shùjù ma?", espanol:"¿Puede facilitar datos de muestra?" },
    { hanzi:"我们关心数据一致性。", pinyin:"Wǒmen guānxīn shùjù yízhìxìng.", espanol:"Nos importa la coherencia de los datos." },
    { hanzi:"平台支持开放标准吗？", pinyin:"Píngtái zhīchí kāifàng biāozhǔn ma?", espanol:"¿La plataforma admite estándares abiertos?" },

    { hanzi:"我们想与您的团队长期合作。", pinyin:"Wǒmen xiǎng yǔ nín de tuánduì chángqī hézuò.", espanol:"Queremos colaborar a largo plazo con su equipo." },
    { hanzi:"我们可以共同开发一个模型。", pinyin:"Wǒmen kěyǐ gòngtóng kāifā yí gè móxíng.", espanol:"Podemos desarrollar un modelo conjunto." },
    { hanzi:"我想了解您在数字化方面的经验。", pinyin:"Wǒ xiǎng liǎojiě nín zài shùzìhuà fāngmiàn de jīngyàn.", espanol:"Quiero conocer su experiencia en digitalización." },
    { hanzi:"这是我们最近的研究成果。", pinyin:"Zhè shì wǒmen zuìjìn de yánjiū chéngguǒ.", espanol:"Estos son nuestros resultados más recientes." },
    { hanzi:"这项技术可以提高准确性。", pinyin:"Zhè xiàng jìshù kěyǐ tígāo zhǔnquèxìng.", espanol:"Esta tecnología mejora la precisión." },
    { hanzi:"我们想讨论跨国数据合作。", pinyin:"Wǒmen xiǎng tǎolùn kuàguó shùjù hézuò.", espanol:"Queremos discutir cooperación internacional de datos." },
    { hanzi:"您怎么看待数据透明度？", pinyin:"Nín zěnme kàndài shùjù tòumíngdù?", espanol:"¿Qué opina sobre la transparencia de datos?" },
    { hanzi:"可以安排一次技术会议吗？", pinyin:"Kěyǐ ānpái yí cì jìshù huìyì ma?", espanol:"¿Podemos organizar una reunión técnica?" },
    { hanzi:"非常感谢史教授的指导。", pinyin:"Fēicháng gǎnxiè Shǐ jiàoshòu de zhǐdǎo.", espanol:"Gracias por su orientación, Profesor Shi." },
    { hanzi:"希望未来我们合作顺利。", pinyin:"Xīwàng wèilái wǒmen hézuò shùnlì.", espanol:"Espero que nuestra colaboración sea exitosa." }
];
        let indice = 0;
        let modo = "TODAS";

        function normalizarEstructuraFrases() {
            frases = frases.map(f => ({
                hanzi: f.hanzi || "",
                pinyin: f.pinyin || "",
                espanol: f.espanol || "",
                attempts: f.attempts || [],
                completions: f.completions || [],
                weeklyMastered: f.weeklyMastered || null,
                monthlyMastered: f.monthlyMastered || null,
                chinoDone: f.chinoDone || false,
                espanolDone: f.espanolDone || false
            }));
        }

        const guardado = localStorage.getItem(STORAGE_KEY);
        if (guardado) {
            try {
                frases = JSON.parse(guardado);
            } catch (e) {
                console.error("Error al cargar datos guardados, se usará la lista por defecto.");
            }
        }
        normalizarEstructuraFrases();

        function guardarFrases() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(frases));
        }

        function numericToMarkedPinyin(text) {
            const toneMarks = {
                'a': ['ā','á','ǎ','à'],
                'e': ['ē','é','ě','è'],
                'i': ['ī','í','ǐ','ì'],
                'o': ['ō','ó','ǒ','ò'],
                'u': ['ū','ú','ǔ','ù'],
                'ü': ['ǖ','ǘ','ǚ','ǜ']
            };

            function applySyllable(match, base, toneDigit) {
                let tone = parseInt(toneDigit, 10);
                if (tone === 5 || tone === 0) return base;

                base = base.toLowerCase().replace(/v/g, "ü");

                let idx = -1;
                for (const ch of ['a','o','e']) {
                    const pos = base.indexOf(ch);
                    if (pos !== -1) { idx = pos; break; }
                }

                if (idx === -1) {
                    if (base.includes("iu")) idx = base.indexOf("u");
                    else if (base.includes("ui")) idx = base.indexOf("i");
                }

                if (idx === -1) {
                    for (let i = base.length - 1; i >= 0; i--) {
                        if ("aeiouü".includes(base[i])) { idx = i; break; }
                    }
                }

                if (idx === -1) return base;

                const ch = base[idx];
                const mark = toneMarks[ch][tone - 1];
                return base.slice(0, idx) + mark + base.slice(idx + 1);
            }

            return text.replace(/([A-Za-züv]+)([1-5])/g, applySyllable);
        }

        function normalizarPinyin(t) {
            return t.trim().replace(/\s+/g, " ").toLowerCase();
        }

        function formatDateTime(ts) {
            if (!ts) return "";
            const d = new Date(ts);
            if (isNaN(d.getTime())) return ts;
            return d.toLocaleString("es-ES");
        }

        function estadoFraseTexto(f) {
            const lastAttempt = f.attempts.length ? f.attempts[f.attempts.length - 1] : null;
            const lastCompletion = f.completions.length ? f.completions[f.completions.length - 1] : null;

            let partes = [];
            if (lastAttempt) {
                partes.push("Última práctica: " + formatDateTime(lastAttempt));
            } else {
                partes.push("Sin práctica registrada.");
            }
            if (lastCompletion) {
                partes.push("Último completado: " + formatDateTime(lastCompletion));
            }
            if (f.weeklyMastered) {
                partes.push("Aprendida semanal: " + formatDateTime(f.weeklyMastered));
            }
            if (f.monthlyMastered) {
                partes.push("Aprendida mensual: " + formatDateTime(f.monthlyMastered));
            }
            return partes.join(" | ");
        }

        function mostrarFrase() {
            const idxSpan = document.getElementById("indiceFrase");
            const hanziModel = document.getElementById("hanziModelo");
            const pinyinModel = document.getElementById("pinyinModelo");
            const espModel = document.getElementById("espanolModelo");
            const modoTxt = document.getElementById("modoTexto");
            const estadoDiv = document.getElementById("estadoFrase");

            if (!frases.length) {
                idxSpan.textContent = "0 / 0";
                hanziModel.textContent = "";
                pinyinModel.textContent = "";
                espModel.textContent = "";
                modoTxt.textContent = "No hay frases definidas.";
                estadoDiv.textContent = "";
                return;
            }

            if (indice >= frases.length) indice = frases.length - 1;
            if (indice < 0) indice = 0;

            const f = frases[indice];
            idxSpan.textContent = (indice + 1) + " / " + frases.length;

            if (modo === "TODAS") {
                hanziModel.textContent = f.hanzi;
                pinyinModel.textContent = f.pinyin;
                espModel.textContent = f.espanol;
                modoTxt.textContent = "Modo: TODAS (ves todas las soluciones).";
            } else if (modo === "CHINO") {
                hanziModel.textContent = f.hanzi;
                pinyinModel.textContent = "";
                espModel.textContent = "";
                modoTxt.textContent = "Modo: CHINO (ves el Hanzi; escribes el español).";
            } else if (modo === "ESPAÑOL") {
                hanziModel.textContent = "";
                pinyinModel.textContent = "";
                espModel.textContent = f.espanol;
                modoTxt.textContent = "Modo: ESPAÑOL (ves el español; escribes Hanzi y Pinyin).";
            }

            estadoDiv.textContent = estadoFraseTexto(f);
        }

        function limpiarRespuestas() {
            document.getElementById("hanziUsuario").value = "";
            document.getElementById("pinyinUsuario").value = "";
            document.getElementById("espanolUsuario").value = "";
            document.getElementById("resultadoHanzi").textContent = "";
            document.getElementById("resultadoPinyin").textContent = "";
            document.getElementById("resultadoEspanol").textContent = "";
        }

        function modoTodas() { modo = "TODAS"; mostrarFrase(); }
        function modoClean() { limpiarRespuestas(); }
        function modoChino() { limpiarRespuestas(); modo = "CHINO"; mostrarFrase(); }
        function modoEspanol() { limpiarRespuestas(); modo = "ESPAÑOL"; mostrarFrase(); }

        function registrarCompletado(f, ahoraISO, prevAttempts) {
            f.completions.push(ahoraISO);

            const ahora = new Date(ahoraISO);
            const doceHorasMs = 12 * 60 * 60 * 1000;
            const sieteDiasMs = 7 * 24 * 60 * 60 * 1000;

            const huboIntentoUlt12h = prevAttempts.some(ts => {
                const t = new Date(ts);
                const diff = ahora - t;
                return diff > 0 && diff <= doceHorasMs;
            });

            const huboIntentoUlt7d = prevAttempts.some(ts => {
                const t = new Date(ts);
                const diff = ahora - t;
                return diff > 0 && diff <= sieteDiasMs;
            });

            if (!huboIntentoUlt12h && !f.weeklyMastered) {
                f.weeklyMastered = ahoraISO;
            }

            if (!huboIntentoUlt7d && !f.monthlyMastered) {
                f.monthlyMastered = ahoraISO;
            }

            f.chinoDone = false;
            f.espanolDone = false;
        }

        function comprobar() {
            if (!frases.length) return;
            const f = frases[indice];

            const hanziUser = document.getElementById("hanziUsuario").value.trim();
            const pinyinUserRaw = document.getElementById("pinyinUsuario").value.trim();
            const espanolUser = document.getElementById("espanolUsuario").value.trim();

            const ahoraISO = new Date().toISOString();
            const prevAttempts = f.attempts.slice();
            f.attempts.push(ahoraISO);

            const resH = document.getElementById("resultadoHanzi");
            const resP = document.getElementById("resultadoPinyin");
            const resE = document.getElementById("resultadoEspanol");

            resH.textContent = "";
            resP.textContent = "";
            resE.textContent = "";

            let hanziCorrecto = false;
            if (hanziUser) {
                if (hanziUser === f.hanzi) {
                    resH.textContent = "Correcto.";
                    hanziCorrecto = true;
                } else {
                    resH.textContent = "Incorrecto. Solución: " + f.hanzi;
                }
            }

            let pinyinCorrecto = false;
            if (pinyinUserRaw) {
                const pinyinConvertido = numericToMarkedPinyin(pinyinUserRaw);
                const esperado = normalizarPinyin(f.pinyin);
                const escritoNorm = normalizarPinyin(pinyinConvertido);

                if (escritoNorm === esperado) {
                    resP.textContent = "Correcto. (" + pinyinConvertido + ")";
                    pinyinCorrecto = true;
                } else {
                    resP.textContent =
                        "Incorrecto. Interpretado como: " + pinyinConvertido +
                        " | Solución: " + f.pinyin;
                }
            }

            let espanolCorrecto = false;
            if (espanolUser) {
                if (espanolUser === f.espanol) {
                    resE.textContent = "Correcto.";
                    espanolCorrecto = true;
                } else {
                    resE.textContent = "Incorrecto. Solución: " + f.espanol;
                }
            }

            if (espanolCorrecto) {
                f.chinoDone = true;
            }
            if (hanziCorrecto && pinyinCorrecto) {
                f.espanolDone = true;
            }

            if (f.chinoDone && f.espanolDone) {
                registrarCompletado(f, ahoraISO, prevAttempts);
            }

            guardarFrases();
            renderTablaFrases();
            mostrarFrase();
        }

        function siguienteFrase() {
            if (!frases.length) return;
            indice = (indice + 1) % frases.length;
            limpiarRespuestas();
            mostrarFrase();
        }

        function anteriorFrase() {
            if (!frases.length) return;
            indice = (indice - 1 + frases.length) % frases.length;
            limpiarRespuestas();
            mostrarFrase();
        }

        function togglePanelFrases() {
            const panel = document.getElementById("panelFrases");
            if (panel.style.display === "none" || panel.style.display === "") {
                renderTablaFrases();
                panel.style.display = "block";
            } else {
                panel.style.display = "none";
            }
        }

        function renderTablaFrases() {
            const tbody = document.getElementById("tablaFrasesBody");
            if (!tbody) return;
            tbody.innerHTML = "";

            frases.forEach((f, idx) => {
                const tr = document.createElement("tr");

                const lastAttempt = f.attempts.length ? f.attempts[f.attempts.length - 1] : null;
                const lastCompletion = f.completions.length ? f.completions[f.completions.length - 1] : null;

                tr.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>
                        <input class="inputTabla" type="text"
                            value="${f.hanzi}"
                            onchange="actualizarFrase(${idx}, 'hanzi', this.value)">
                    </td>
                    <td>
                        <input class="inputTabla" type="text"
                            value="${f.pinyin}"
                            onchange="actualizarFrase(${idx}, 'pinyin', this.value)">
                    </td>
                    <td>
                        <input class="inputTabla" type="text"
                            value="${f.espanol}"
                            onchange="actualizarFrase(${idx}, 'espanol', this.value)">
                    </td>
                    <td>${formatDateTime(lastAttempt)}</td>
                    <td>${formatDateTime(lastCompletion)}</td>
                    <td>${f.weeklyMastered ? formatDateTime(f.weeklyMastered) : ""}</td>
                    <td>${f.monthlyMastered ? formatDateTime(f.monthlyMastered) : ""}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function actualizarFrase(ind, campo, valor) {
            frases[ind][campo] = valor;
            guardarFrases();
            if (ind === indice) mostrarFrase();
        }

        function anadirFrase() {
            const h = document.getElementById("nuevoHanzi").value.trim();
            const p = document.getElementById("nuevoPinyin").value.trim();
            const e = document.getElementById("nuevoEspanol").value.trim();

            if (!h || !p || !e) {
                alert("Rellena Hanzi, Pinyin y Español para añadir una nueva frase.");
                return;
            }

            frases.push({
                hanzi: h,
                pinyin: p,
                espanol: e,
                attempts: [],
                completions: [],
                weeklyMastered: null,
                monthlyMastered: null,
                chinoDone: false,
                espanolDone: false
            });

            document.getElementById("nuevoHanzi").value = "";
            document.getElementById("nuevoPinyin").value = "";
            document.getElementById("nuevoEspanol").value = "";

            guardarFrases();
            renderTablaFrases();
            mostrarFrase();
        }

        function exportarHistorial() {
            if (!frases.length) {
                alert("No hay frases para exportar.");
                return;
            }

            let lineas = [];
            lineas.push([
                "N","Hanzi","Pinyin","Espanol",
                "NumIntentos","NumCompletados",
                "UltimoIntento","UltimoCompletado",
                "AprendidoSemanal","AprendidoMensual"
            ].join(";"));

            frases.forEach((f, idx) => {
                const lastAttempt = f.attempts.length ? f.attempts[f.attempts.length - 1] : "";
                const lastCompletion = f.completions.length ? f.completions[f.completions.length - 1] : "";

                lineas.push([
                    idx + 1,
                    `"${(f.hanzi || "").replace(/"/g,'""')}"`,
                    `"${(f.pinyin || "").replace(/"/g,'""')}"`,
                    `"${(f.espanol || "").replace(/"/g,'""')}"`,
                    f.attempts.length || 0,
                    f.completions.length || 0,
                    lastAttempt ? formatDateTime(lastAttempt) : "",
                    lastCompletion ? formatDateTime(lastCompletion) : "",
                    f.weeklyMastered ? formatDateTime(f.weeklyMastered) : "",
                    f.monthlyMastered ? formatDateTime(f.monthlyMastered) : ""
                ].join(";"));
            });

            const csv = lineas.join("\r\n");
            const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "historial_frases.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Registro del service worker (PWA)
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js").catch(err => {
                console.error("Error registrando service worker:", err);
            });
        }

        mostrarFrase();
    </script>
</body>
</html>

